#!/bin/bash
# Copyright (C) 2011 Ion Torrent Systems, Inc. All Rights Reserved
set -e

case "$1" in
	configure)
    
    	# Test for X server running
#        if ps -ef|grep /usr/bin/X|grep -v grep >/dev/null; then
#        	echo
#            echo "************************************************"
#        	echo
#            echo "WARNING:"
#            echo "X server is running.  nVidia device drivers will"
#            echo "not be installed.  If you want the GPU enabled,"
#            echo "shut down the X server and run this package install"
#            echo "again.  Otherwise, ignore this warning."
#            echo
#        	echo "************************************************"
#            echo
#            exit 0
#        fi
        
        # Test for nvidia graphics device
        if ! lspci|grep -i "nvidia"|egrep '(3D controller|VGA compatible controller)';then
        	echo
            echo "************************************************"
        	echo
            echo "WARNING:"
            echo "No compatible nVidia hardware detected."
            echo "nVidia device driver will not be installed."
            echo
        	echo "************************************************"
            echo
            exit 0
        fi
        
        # filter out devices with (rev ff).
        if lspci|grep -i "nvidia"|egrep '(3D controller|VGA compatible controller)'|grep 'rev ff';then
        	echo
            echo "************************************************"
        	echo
            echo "WARNING:"
            echo "nVidia hardware is detected but the device code indicates a hardware problem."
            echo "Try reinstalling the nVidia card and then reinstalling this package."
            echo "Device is:"
            echo `lspci|grep -i "nvidia"|egrep '(3D controller|VGA compatible controller)'`
            echo
        	echo "************************************************"
            echo
            exit 0
        fi
        
        # Extract Device Driver Package
        echo "Extract Device Driver Package"
        rm -rf @ION_GPU_PREFIX@/devdriver
        bash @ION_GPU_PREFIX@/devdriver_*.run \
            --extract-only \
            --target @ION_GPU_PREFIX@/devdriver > /tmp/nvidiadriver_install.log
        
        # Prevent nouveau driver from running
        (modprobe -r nouveau) || true
        echo -e "# generated by nvidia-installer\nblacklist nouveau\noptions nouveau modeset=0" > /etc/modprobe.d/nvidia-installer-disable-nouveau.conf
        
        # Run Device Driver installer
        # catch error in installation before exiting
        set +e
        echo "Install Nvidia Device Driver (see /tmp/nvidiadriver_install.log)"
        cd @ION_GPU_PREFIX@/devdriver >/dev/null
        ./nvidia-installer \
            --accept-license \
            --no-questions \
            --ui=none \
            --dkms \
            --run-nvidia-xconfig \
	    --no-x-check \
	    --no-cc-version-check >& /tmp/nvidiadriver_install.log

        install_status=$?
        nvidia_installer_log="/var/log/nvidia-installer.log"
        if [ $install_status -eq 0 ]; then
          set -e
        elif [ -e $nvidia_installer_log ]; then
          if grep -E "NVIDIA Linux graphics driver will ignore this GPU" $nvidia_installer_log >> /dev/null; then
            echo
            echo "************************************************"
            echo
            echo "WARNING:"
            echo "Following NVIDIA GPU's are no longer supported on this operating system."
            echo "Device is:"
            echo `lspci|grep -i "nvidia"|egrep '(3D controller|VGA compatible controller)'`
            echo
        	echo "************************************************"
            echo
          else
            echo "Nvidia driver installation failed. Look for more details in /var/log/nvidia-installer.log"
          fi  
          exit $?
        fi
       
        cd - >/dev/null

        # create nvidia device files
        if [ -e /etc/rc.local ]; then 
            @ION_GPU_PREFIX@/create_nvidia_files
	fi
        
        # Edit the rc.local file
        if [ -e /etc/rc.local ]; then 
	        sed -i "/create_nvidia_files/d" /etc/rc.local
                sed -i "s:^exit 0:@ION_GPU_PREFIX@/create_nvidia_files\nexit 0:" /etc/rc.local
	fi
    	if [ -f "/software/datacollect.avx" ]; then
		# remove xorg.conf (installed by CUDA)
		rm -rf /etc/X11/xorg.conf
	
		if [ "Enabled" == "`nvidia-smi -a | sed -e"/Ecc Mode/{x;N;p};d" | sed -e ':a;N;$!ba;s/\n/ /g' | sed -e 's/.*: //'`" ]; then
		    # disable ECC support
		    nvidia-smi -e 0
		fi
	fi

	;;
    
    abort-install|abort-upgrade)
    	rm -rf @ION_GPU_PREFIX@/devdriver
        rm -rf /etc/modprobe.d/nvidia-installer-disable-nouveau.conf
        if [ -e /etc/rc.local ]; then 
            sed -i "/create_nvidia_files/d" /etc/rc.local
	    fi
    ;;
esac

exit 0
